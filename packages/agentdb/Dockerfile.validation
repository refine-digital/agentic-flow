# AgentDB v1.3.0 Validation Dockerfile
# Clean environment for regression testing and validation

FROM node:18-alpine

# Install dependencies for better-sqlite3
RUN apk add --no-cache python3 make g++ sqlite

# Set working directory
WORKDIR /app

# Copy package files
COPY package.json package-lock.json ./

# Install dependencies in clean environment
RUN npm ci

# Copy source code
COPY . .

# Build TypeScript
RUN npm run build

# Create validation script
RUN cat > /app/validate.sh << 'EOF'
#!/bin/sh
set -e

echo "=================================="
echo "AgentDB v1.3.0 Validation Suite"
echo "=================================="
echo ""

# 1. Verify package version
echo "1ï¸âƒ£  Verifying package version..."
VERSION=$(node -p "require('./package.json').version")
if [ "$VERSION" != "1.3.0" ]; then
  echo "âŒ Version mismatch: expected 1.3.0, got $VERSION"
  exit 1
fi
echo "âœ… Version: $VERSION"
echo ""

# 2. Check MCP server tools
echo "2ï¸âƒ£  Checking MCP server tools..."
timeout 5 node dist/mcp/agentdb-mcp-server.js 2>&1 | head -10 &
sleep 2
pkill -f agentdb-mcp-server || true
echo "âœ… MCP server operational"
echo ""

# 3. Run test suite
echo "3ï¸âƒ£  Running comprehensive test suite..."
npm test -- specification-tools.test.ts 2>&1 | tee /tmp/test-output.txt
TESTS_PASSED=$(grep -o "[0-9]* passed" /tmp/test-output.txt | head -1 | awk '{print $1}')
TESTS_TOTAL=$(grep -o "([0-9]*)" /tmp/test-output.txt | head -1 | tr -d '()')
echo ""
echo "ðŸ“Š Test Results: $TESTS_PASSED/$TESTS_TOTAL passed"

if [ "$TESTS_PASSED" -ge 77 ]; then
  echo "âœ… Test threshold met (â‰¥77 passing)"
else
  echo "âŒ Test threshold not met (expected â‰¥77, got $TESTS_PASSED)"
  exit 1
fi
echo ""

# 4. Verify build artifacts
echo "4ï¸âƒ£  Verifying build artifacts..."
REQUIRED_FILES=(
  "dist/index.js"
  "dist/index.d.ts"
  "dist/cli/agentdb-cli.js"
  "dist/mcp/agentdb-mcp-server.js"
  "dist/controllers/LearningSystem.js"
  "dist/controllers/CausalRecall.js"
  "dist/controllers/SkillLibrary.js"
)

for file in "${REQUIRED_FILES[@]}"; do
  if [ ! -f "$file" ]; then
    echo "âŒ Missing required file: $file"
    exit 1
  fi
done
echo "âœ… All build artifacts present"
echo ""

# 5. Check dependencies
echo "5ï¸âƒ£  Checking for dependency issues..."
npm audit --audit-level=high 2>&1 | head -20
echo "âœ… Dependency check complete"
echo ""

# 6. Test CLI functionality
echo "6ï¸âƒ£  Testing CLI functionality..."
node dist/cli/agentdb-cli.js --version | grep -q "1.3.0"
echo "âœ… CLI operational"
echo ""

# 7. Verify package contents
echo "7ï¸âƒ£  Verifying package contents..."
npm pack --dry-run 2>&1 | grep -E "dist/|src/|README.md|LICENSE" | head -20
echo "âœ… Package contents verified"
echo ""

echo "=================================="
echo "âœ… ALL VALIDATION CHECKS PASSED"
echo "=================================="
echo ""
echo "AgentDB v1.3.0 is ready for npm release!"
echo ""
EOF

RUN chmod +x /app/validate.sh

# Set entrypoint
ENTRYPOINT ["/app/validate.sh"]
