name: Sync fork with upstream
on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      new_commits: ${{ steps.merge.outputs.new_commits }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_PAT || secrets.GITHUB_TOKEN }}

      - name: Sync upstream
        id: merge
        env:
          GIT_PUSH_TOKEN: ${{ secrets.SYNC_PAT || secrets.GITHUB_TOKEN }}
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git remote add upstream https://github.com/ruvnet/agentic-flow.git
          git fetch upstream
          git fetch origin
          git reset --hard origin/main

          BEFORE=$(git rev-parse HEAD)
          git merge upstream/main --no-edit -X ours
          AFTER=$(git rev-parse HEAD)

          if [ "$BEFORE" != "$AFTER" ]; then
            echo "new_commits=true" >> $GITHUB_OUTPUT
            echo "Upstream had new commits"
          else
            echo "new_commits=false" >> $GITHUB_OUTPUT
            echo "Already up to date"
          fi

          git remote set-url origin https://x-access-token:${GIT_PUSH_TOKEN}@github.com/${{ github.repository }}.git
          git push origin main

      - name: Disable all workflows except this one
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/actions/workflows \
            --paginate \
            --jq '.workflows[] | select(.path != ".github/workflows/sync-upstream.yml") | .id' \
          | while read id; do
              gh api -X PUT repos/${{ github.repository }}/actions/workflows/${id}/disable \
                && echo "Disabled workflow: ${id}" \
                || echo "Already disabled or error: ${id}"
            done

  monitor:
    needs: sync
    uses: ./.github/workflows/monitor-fork-patches.yml
    with:
      new_commits: ${{ needs.sync.outputs.new_commits == 'true' }}
    permissions:
      contents: read
      issues: write
